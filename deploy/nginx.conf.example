# Nginx 反向代理配置示例
# 用于将应用部署在子路径下（如 /rpc-parser/）

# 上游服务器配置
upstream rpc_parser_backend {
    server 127.0.0.1:8000;
    keepalive 32;
}

server {
    listen 80;
    server_name your-server.nokia.com;

    # 重定向到 HTTPS（生产环境推荐）
    # return 301 https://$server_name$request_uri;

    # 如果不使用 HTTPS，可以直接在这里配置
    include /etc/nginx/snippets/rpc-parser-location.conf;
}

server {
    listen 443 ssl http2;
    server_name your-server.nokia.com;

    # SSL 证书配置
    ssl_certificate /etc/ssl/certs/your-cert.pem;
    ssl_certificate_key /etc/ssl/private/your-key.pem;

    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    include /etc/nginx/snippets/rpc-parser-location.conf;
}

# ==================== Location 配置片段 ====================
# 保存为 /etc/nginx/snippets/rpc-parser-location.conf

# location 配置（用于子路径部署）
location /rpc-parser/ {
    # 代理到后端
    proxy_pass http://rpc_parser_backend/;

    # 代理头设置
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /rpc-parser;

    # WebSocket 支持（如果需要）
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # 缓冲设置
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;

    # 文件上传大小限制
    client_max_body_size 100M;
}

# 静态资源缓存（可选，如果前端资源通过 Nginx 直接服务）
location /rpc-parser/assets/ {
    alias /var/www/rpc-parser/frontend/dist/assets/;

    # 缓存配置（带 hash 的文件名可以长期缓存）
    expires 1y;
    add_header Cache-Control "public, immutable";

    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
